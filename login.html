
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMCS Portal | Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        input:-webkit-autofill,
        input:-webkit-autofill:hover, 
        input:-webkit-autofill:focus {
            -webkit-text-fill-color: white !important;
            -webkit-box-shadow: 0 0 0px 1000px #0a0a0a inset !important;
            transition: background-color 5000s ease-in-out 0s;
        }
        body { font-family: 'Inter', sans-serif; background-color: #050505; color: white; margin: 0; }
        .logo-container { position: fixed; inset: 0; z-index: -1; display: flex; justify-content: center; align-items: center; opacity: 0.12; pointer-events: none; }
        .logo-container img { height: 90%; width: auto; max-width: none; object-fit: contain; filter: grayscale(1) brightness(0.4); }
        .glass-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 2.2rem; }
        .input-field { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); padding: 0.75rem 1.1rem !important; transition: border 0.4s ease; }
        .btn-anchor { width: 100%; height: 52px; display: flex; justify-content: center; align-items: center; margin-top: 1.5rem; position: relative; }
        #submitBtn { width: 100%; height: 52px; background: white; color: black; border-radius: 9999px; font-weight: 800; font-size: 14px; cursor: pointer; border: none; box-shadow: 0 10px 20px rgba(0,0,0,0.2); white-space: nowrap; display: flex; align-items: center; justify-content: center; }
        footer { position: absolute; bottom: 24px; width: 100%; text-align: center; font-size: 10px; letter-spacing: 0.1em; color: rgba(255, 255, 255, 0.3); z-index: 5; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">
    <div class="logo-container">
        <img src="https://sklepagatesting.github.io/resources/Images/CMCSlogo.png" alt="CMCS Logo">
    </div>

    <div class="max-w-[400px] w-full relative z-10">
        <div class="text-center mb-10">
            <img src="https://sklepagatesting.github.io/resources/Images/CMCSlogo.png" alt="CMCS Logo" class="w-16 mx-auto mb-6 brightness-125">
            <h1 class="text-4xl md:text-5xl font-bold py-1 bg-clip-text tracking-tight mb-4 text-transparent bg-gradient-to-b from-white to-gray-400 leading-normal">Login</h1>
            <p id="para-text" class="text-gray-400 text-sm md:text-base max-w-xs mx-auto">Only verified accounts can access the system.</p>
        </div>

        <div class="glass-card p-8">
            <form id="loginForm" class="space-y-5">
                <div class="space-y-2">
                    <label class="field-label text-gray-400 text-sm md:text-base ml-1">Email</label>
                    <input type="email" id="email" name="email" autocomplete="username" class="w-full input-field rounded-2xl outline-none font-medium text-sm text-white" required>
                </div>
                <div class="space-y-2">
                    <label class="field-label text-gray-400 text-sm md:text-base ml-1">Password</label>
                    <div class="relative">
                        <input type="password" id="pw" name="password" autocomplete="current-password" class="w-full input-field rounded-2xl outline-none font-medium text-sm text-white pr-12" required>
                        <i id="togglePw" class="fa-solid fa-eye absolute right-4 top-1/2 -translate-y-1/2 text-xs opacity-30 cursor-pointer"></i>
                    </div>
                </div>
                <div class="btn-anchor">
                    <button type="submit" id="submitBtn">Authenticate</button>
                </div>
            </form>

            <div class="mt-8 text-center border-t border-white/5 pt-6">
                <p class="text-[10px] font-bold text-gray-600 uppercase tracking-widest mb-4">No account yet?</p>
                <div class="flex justify-center items-center gap-6">
                    <a href="enroll.html" class="text-xs font-semibold text-white/50 hover:text-white transition-all">Register student</a>
                    <span class="text-white/10 w-[1px] h-3 bg-white/10"></span>
                    <a href="enroll_teacher.html" class="text-xs font-semibold text-white/50 hover:text-white transition-all">Register faculty</a>
                </div>
            </div>
        </div>
    </div>

    <footer>
        Copyright &copy; <span id="year"></span> Central Mindanao Computer School Inc.<br>All rights reserved.
    </footer>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    // Supabase Configuration
    const supabaseUrl = 'https://flrxdppyhfegojcrskgp.supabase.co'
    const supabaseKey = 'sb_publishable_EE7r6GWNuO9b_Mcx1I1VMA_M-gfzTnA'
    const supabase = createClient(supabaseUrl, supabaseKey)

    // Setup Year
    document.getElementById('year').textContent = new Date().getFullYear();

    const btn = document.getElementById('submitBtn');
    const pwInput = document.getElementById('pw');
    let activeTl;

    // --- Disable Autofill logic ---
    const inputs = document.querySelectorAll('.input-field');
    inputs.forEach(input => {
        input.setAttribute('readonly', 'readonly');
        input.style.cursor = 'text';
        const stopReadOnly = () => {
            input.removeAttribute('readonly');
            input.removeEventListener('focus', stopReadOnly);
            input.removeEventListener('mousedown', stopReadOnly);
        };
        input.addEventListener('focus', stopReadOnly);
        input.addEventListener('mousedown', stopReadOnly);
    });

    // Toggle Password visibility
    document.getElementById('togglePw').addEventListener('click', () => {
        pwInput.type = pwInput.type === 'password' ? 'text' : 'password';
    });

    // Login Handler
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if(activeTl) activeTl.kill();

        activeTl = gsap.timeline({ defaults: { ease: "power4.inOut" } });
        activeTl.to(btn, {
            width: "140px", height: "38px", backgroundColor: "rgba(255, 255, 255, 0.1)",
            color: "#ffffff", fontSize: "12px", duration: 1.2, innerText: "Checking", opacity: 0.6
        });

        const email = document.getElementById('email').value.trim();
        const password = pwInput.value;

        try {
            // 1. Supabase Sign In
            const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                email,
                password,
            });

            if (authError) throw authError;

            // 2. Fetch User Profile from PostgreSQL
            const { data: userData, error: dbError } = await supabase
                .from('users')
                .select('*')
                .eq('id', authData.user.id)
                .single();

            // --- GHOST ACCOUNT CHECK ---
            if (dbError || !userData) {
                // If the record doesn't exist in the database, sign them out immediately
                await supabase.auth.signOut();
                throw new Error("purged");
            }

            // Check if account is restricted/disabled
            if (userData.status === "disabled") {
                await supabase.auth.signOut();
                throw new Error("blocked");
            }

            // Check if account is still pending
            if (userData.status !== "approved") {
                await supabase.auth.signOut();
                throw new Error("pending");
            }

            // SUCCESS: Proceed to Dashboard
            activeTl = gsap.timeline({ defaults: { ease: "power4.inOut" } });
            activeTl.to(btn, {
                width: "100%", height: "52px", backgroundColor: "#ffffff", color: "#000000",
                fontSize: "14px", innerText: "Verified", opacity: 1, duration: 1.0
            });
            
            setTimeout(() => window.location.href = `${userData.role}_dashboard.html`, 1400);

        } catch (err) {
            if(activeTl) activeTl.kill();
            
            let errorMsg = "Denied";
            if (err.message === "pending") errorMsg = "Approval Pending";
            else if (err.message === "blocked") errorMsg = "Access Restricted";
            else if (err.message === "purged") errorMsg = "Account Deactivated";
            else if (err.message.includes("Invalid login credentials")) errorMsg = "Invalid Login";

            activeTl = gsap.timeline({ defaults: { ease: "power4.inOut" } });
            activeTl.to(btn, { 
                backgroundColor: "rgba(255, 59, 48, 0.2)", 
                innerText: errorMsg,
                color: "#ff3b30",
                duration: 0.4 
            })
            .to(btn, { x: -4, duration: 0.1, repeat: 3, yoyo: true, ease: "linear" }, 0)
            .to(btn, {
                width: "100%", height: "52px", backgroundColor: "#ffffff", color: "#000000",
                fontSize: "14px", innerText: "Authenticate", x: 0, opacity: 1,
                duration: 1.2, delay: 1.2
            });
        }
    });
</script>
</body>
</html>
