<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Enrollment | CMCS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #050505;
            color: white;
            margin: 0;
            overflow-x: hidden;
        }
        .logo-container {
            position: fixed;
            inset: 0;
            z-index: -1;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0.08;
            pointer-events: none;
        }
        .logo-container img {
            height: 90%;
            width: auto;
            max-width: none;
            object-fit: contain;
            filter: grayscale(1) brightness(0.4);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 2.2rem;
        }
        .input-field {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.75rem 1.1rem !important;
            transition: all 0.3s ease;
            color: white;
        }
        .input-field:focus {
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.08);
            outline: none;
        }
        select.input-field option {
            background: #1a1a1a;
            color: white;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(1);
        cursor: pointer;
        opacity: 0.6;
        transition: opacity 0.3s ease;
        }

        input[type="date"]::-webkit-calendar-picker-indicator:hover {
        opacity: 1;
        }
        .btn-anchor {
            width: 100%;
            height: 58px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 2rem;
            position: relative;
        }
        #submitBtn {
            width: 100%;
            height: 58px;
            background: white;
            color: black;
            border-radius: 9999px;
            font-weight: 800;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            border: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #msgModal {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: 100;
        }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 py-12">

    <div class="logo-container">
        <img src="https://sklepagatesting.github.io/resources/Images/CMCSlogo.png" alt="CMCS Logo">
    </div>

    <div id="msgModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4">
        <div class="glass-card p-8 max-w-sm w-full text-center border-white/20">
            <div id="modalIcon" class="text-5xl mb-4"></div>
            <h3 id="modalTitle" class="text-xl font-bold mb-2">Notice</h3>
            <p id="modalMsg" class="text-gray-400 text-sm mb-8"></p>
            <button onclick="closeModal()" class="w-full bg-white text-black py-4 rounded-full font-bold text-sm hover:opacity-90 transition-all">Continue</button>
        </div>
    </div>

    <div class="max-w-4xl w-full relative z-10">
        <div class="text-center mb-10">
            <img src="https://sklepagatesting.github.io/resources/Images/CMCSlogo.png" 
                 alt="CMCS Logo" class="w-16 mx-auto mb-6 brightness-125">
            <h1 class="text-3xl md:text-5xl font-bold tracking-tight mb-2 bg-clip-text text-transparent bg-gradient-to-b from-white to-gray-400">
                Student Enrollment
            </h1>
            <p class="text-gray-500 text-xs font-bold uppercase tracking-[0.4em]">Academic Year 2026-2027</p>
        </div>

        <div class="glass-card p-6 md:p-10">
            <form id="studentForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-gray-400 text-sm ml-1">Last name</label>
                        <input type="text" id="ln" pattern=".*\S.*" class="w-full input-field rounded-2xl text-sm font-semibold uppercase" required>
                    </div>
                    <div class="space-y-2">
                        <label class="text-gray-400 text-sm ml-1">First name</label>
                        <input type="text" id="fn" pattern=".*\S.*" class="w-full input-field rounded-2xl text-sm font-semibold uppercase" required>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-2">
                        <label class="text-gray-400 text-sm ml-1">Gender</label>
                        <select id="gender" class="w-full input-field rounded-2xl text-sm font-semibold" required>
                            <option value="" disabled selected>Select</option>
                            <option value="MALE">MALE</option>
                            <option value="FEMALE">FEMALE</option>
                        </select>
                    </div>
                <div class="md:col-span-2 space-y-2">
                <label class="text-gray-400 text-sm ml-1">Date of birth</label>
                <input type="date" id="bday" class="w-full input-field rounded-2xl text-sm font-semibold" required>
                </div>
                </div>

                <div class="space-y-2">
                    <label class="text-gray-400 text-sm ml-1">Complete home address</label>
                    <input type="text" id="address" pattern=".*\S.*" class="w-full input-field rounded-2xl text-sm font-semibold" required>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t border-white/5">
                    <div class="space-y-2">
                        <label class="text-gray-400 text-sm ml-1">Student id</label>
                        <input type="text" id="studentId" maxlength="8" class="w-full input-field rounded-2xl text-sm font-bold" required>
                    </div>
                    <div class="space-y-2">
                        <label class="text-gray-400 text-sm ml-1">Course program</label>
                        <select id="course" class="w-full input-field rounded-2xl text-sm font-semibold" required>
                            <option value="" disabled selected>Select</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-gray-400 text-sm ml-1">Year level</label>
                        <select id="year" class="w-full input-field rounded-2xl text-sm font-semibold" required>
                            <option value="" disabled selected>Select</option>
                            <option value="1">1ST YEAR</option>
                            <option value="2">2ND YEAR</option>
                            <option value="3">3RD YEAR</option>
                            <option value="4">4TH YEAR</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-gray-400 text-sm ml-1">Semester</label>
                        <select id="semester" class="w-full input-field rounded-2xl text-sm font-semibold" required>
                            <option value="" disabled selected>Select</option>
                            <option value="1ST SEMESTER">1ST SEMESTER</option>
                            <option value="2ND SEMESTER">2ND SEMESTER</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t border-white/5">
                    <div class="space-y-2">
                        <label class="text-gray-400 text-sm ml-1">Email address</label>
                        <input type="email" id="email" pattern=".*\S.*" class="w-full input-field rounded-2xl text-sm font-semibold" required>
                    </div>
                    <div class="space-y-2 relative">
                        <label class="text-gray-400 text-sm ml-1">Password</label>
                        <div class="relative">
                            <input type="password" id="pw" pattern=".*\S.*" class="w-full input-field rounded-2xl text-sm font-semibold pr-12" required>
                            <button type="button" onclick="togglePassword()" class="absolute right-4 top-1/2 -translate-y-1/2 text-white/30 hover:text-white transition-colors">
                                <i id="eyeIcon" class="fa-solid fa-eye text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="btn-anchor">
                    <button type="submit" id="submitBtn">Submit Enrollment</button>
                </div>
            </form>
        </div>
    </div>

<script type="module">
    // Import Supabase CDN
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const supabaseUrl = 'https://flrxdppyhfegojcrskgp.supabase.co'
    const supabaseKey = 'EE7r6GWNuO9b_Mcx1I1VMA_M-gfzTnA'
    const supabase = createClient(supabaseUrl, supabaseKey)

    // --- Disable Autofill logic ---
    const inputs = document.querySelectorAll('.input-field');
    inputs.forEach(input => {
        input.setAttribute('readonly', 'readonly');
        input.style.cursor = 'text';
        const stopReadOnly = () => {
            input.removeAttribute('readonly');
            input.removeEventListener('focus', stopReadOnly);
        };
        input.addEventListener('focus', stopReadOnly);
    });

    const urlParams = new URLSearchParams(window.location.search);
    const editId = urlParams.get('edit');
    const btn = document.getElementById('submitBtn');
    const studentIdInput = document.getElementById('studentId');
    let activeTl;
    let redirectOnClose = false;

    // --- 1. Student ID Formatter ---
    studentIdInput.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, ''); 
        let formatted = '';
        if (value.length > 0) formatted += value.substring(0, 2);
        if (value.length > 2) formatted += '-' + value.substring(2, 3);
        if (value.length > 3) formatted += '-' + value.substring(3, 6);
        e.target.value = formatted;
    });

    // --- 2. UI Helpers ---
    window.togglePassword = () => {
        const pw = document.getElementById('pw');
        const icon = document.getElementById('eyeIcon');
        pw.type = pw.type === 'password' ? 'text' : 'password';
        icon.classList.toggle('fa-eye');
        icon.classList.toggle('fa-eye-slash');
    };

    window.showModal = (title, msg, type = 'success', redirect = false) => {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMsg').innerText = msg;
        const icon = document.getElementById('modalIcon');
        icon.innerHTML = type === 'success' 
            ? '<i class="fa-solid fa-circle-check text-emerald-500"></i>' 
            : '<i class="fa-solid fa-circle-xmark text-rose-500"></i>';
        document.getElementById('msgModal').style.display = 'flex';
        redirectOnClose = redirect;
    };

    window.closeModal = () => {
        document.getElementById('msgModal').style.display = 'none';
        if(redirectOnClose) window.close(); 
    };

    // --- 3. Data Loading ---
    async function loadCourses() {
        try {
            const { data, error } = await supabase.from('courses').select('name');
            if (error) throw error;
            const sel = document.getElementById('course');
            let options = '<option value="" disabled selected>Select</option>';
            data.forEach(d => { 
                const name = d.name.toUpperCase();
                options += `<option value="${name}">${name}</option>`; 
            });
            sel.innerHTML = options;
        } catch (e) { console.error("Course load error:", e); }
    }

    async function initForm() {
        await loadCourses();
        if (editId) {
            document.querySelector('h1').innerText = "Update Profile";
            btn.innerText = "Update Record";
            document.getElementById('pw').required = false;
            document.getElementById('pw').closest('.space-y-2').parentElement.classList.add('hidden');
            document.getElementById('email').readOnly = true;

            const { data, error } = await supabase.from('users').select('*').eq('id', editId).single();
            if (data) {
                document.getElementById('ln').value = data.lastname;
                document.getElementById('fn').value = data.firstname;
                document.getElementById('gender').value = data.gender;
                document.getElementById('bday').value = data.birthdate;
                document.getElementById('address').value = data.address;
                document.getElementById('studentId').value = data.studentId;
                document.getElementById('course').value = data.course;
                document.getElementById('year').value = data.year;
                document.getElementById('semester').value = data.semester;
                document.getElementById('email').value = data.email;
            }
        }
    }

    // --- 4. Submission ---
    document.getElementById('studentForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const studentIdValue = studentIdInput.value;
        const firstName = document.getElementById('fn').value.toUpperCase().trim();
        const lastName = document.getElementById('ln').value.toUpperCase().trim();
        const email = document.getElementById('email').value.trim().toLowerCase();

        // Animation
        if(activeTl) activeTl.kill();
        activeTl = gsap.timeline({ defaults: { ease: "power4.inOut" } });
        activeTl.to(btn, { width: "160px", height: "40px", backgroundColor: "rgba(255, 255, 255, 0.1)", color: "#ffffff", fontSize: "12px", duration: 1.2, innerText: "Checking", opacity: 0.6 });

        try {
            if (!editId) {
                // Duplicate ID Check
                const { data: existingId } = await supabase.from('users').select('studentId').eq('studentId', studentIdValue).maybeSingle();
                if (existingId) throw new Error("Student ID already exists.");

                // Duplicate Name Check
                const { data: existingName } = await supabase.from('users').select('id').eq('firstname', firstName).eq('lastname', lastName).maybeSingle();
                if (existingName) throw new Error("A student with this name is already enrolled.");
            }

            const userData = {
                firstname: firstName,
                lastname: lastName,
                gender: document.getElementById('gender').value.toUpperCase(),
                birthdate: document.getElementById('bday').value,
                address: document.getElementById('address').value.toUpperCase(),
                studentId: studentIdValue,
                course: document.getElementById('course').value.toUpperCase(),
                year: document.getElementById('year').value,
                semester: document.getElementById('semester').value.toUpperCase(),
            };

            if (editId) {
                const { error } = await supabase.from('users').update(userData).eq('id', editId);
                if (error) throw error;
                showModal("Update Successful", "Student record updated.", "success", true);
            } else {
                const password = document.getElementById('pw').value;
                
                // 1. Sign up user in Auth
                const { data: authData, error: authError } = await supabase.auth.signUp({ email, password });
                if (authError) throw authError;

                // 2. Insert into users table
                const { error: dbError } = await supabase.from('users').insert([{
                    id: authData.user.id,
                    ...userData,
                    email: email,
                    role: 'student',
                    status: 'pending'
                }]);
                if (dbError) throw dbError;

                showModal("Success", "Enrollment submitted for review.", "success", true);
            }
            activeTl.to(btn, { width: "100%", height: "58px", backgroundColor: "#fff", color: "#000", innerText: "Success", opacity: 1 });

        } catch (err) {
            if(activeTl) activeTl.kill();
            activeTl = gsap.timeline({ defaults: { ease: "power4.inOut" } });
            activeTl.to(btn, { backgroundColor: "rgba(255, 59, 48, 0.2)", innerText: "Denied", color: "#ff3b30", duration: 0.4 })
                    .to(btn, { x: -4, duration: 0.1, repeat: 3, yoyo: true }, 0)
                    .to(btn, { width: "100%", height: "58px", backgroundColor: "#fff", color: "#000", innerText: editId ? "Update Record" : "Submit Enrollment", x: 0, opacity: 1, duration: 1.2, delay: 1.5 });

            showModal("Enrollment Error", err.message, "error");
        }
    });

    initForm();
</script>
</body>
</html>
